---
title: "midcab_demographics"
author: "Salil V Deo"
date: "4/18/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report for initial data cleaning for the **midcab** paper.

```{r get libraries}

library(easypackages)
libraries(c("tidyverse","pastecs","skimr",
           "readxl","readr","survival","relsurv","lubridate","gmodels"))



proc_desc <- function(x){
  # require library(pastecs)
  result <- round(stat.desc(x),2)
  hist(x, col = "skyblue")
  result
}


proc_tab <- function(x){
  # require libary(gmodels)
  CrossTable(x, format = "SPSS")
  
}


# na converter


input_na <- function(x, y){
  ifelse(x == y, NA, x)
}
```



```{r}

# get data
# this the sheet 1 for the file 


df <- read_excel("C:\\github_rcode\\midcab\\data\\new_table.xlsx", sheet = 1)

dim(df)

glimpse(df)

#- to see if any duplicates exist

duplicated_id <- df %>% 
  group_by(Pat_ID) %>%
  filter(duplicated(Pat_ID)| n() != 1) %>%
  select(Pat_ID)

duplicated_id
# the duplicated rows are because they have different last contact dates
# am going to remove duplicates and keep the last instance of follow-up time of duplicates here.
# arrange according to id and then last contact date

df2 <- df %>% arrange(Pat_ID, last_contact_date)

# now going to remove duplicates in patient id as they are unique

df3 <- df2[!rev(duplicated(rev(df2$Pat_ID))), ]

#- df3 now has the single row which has the more recent contact date

#- so df3 is now the master

```


table df3 is the master now.



```{r}

# get the first 10 col

d <- df3

glimpse(d)

```

```{r}
# age 

proc_desc(d$age_at_surgery)

# age ok ; no missing 

# convert dates to date in R 

d$date_of_surgery <- as_date(d$date_of_surgery)

d$dob <- as_date(d$dob)

# gender

str(d$gender)

table(d$gender, useNA = 'ifany') # no missing gender 1 = male, 2= female

# conv to female

d$female <- d$gender - 1

d$female <- factor(d$female, levels = c(0,1), labels = c("no","yes"))

proc_tab(d$female)

# height_cm

proc_desc(d$height_cm) # missing = -9

# convert that to missing data

d$height_cm[d$height_cm == -9]<- NA

proc_desc(d$height_cm) 

```


now go for the next 10 variables 

```{r}
d2 <- d

glimpse(d2)
```


```{r}

# weight

d2$weight_kg[d2$weight_kg == -9]<- NA

proc_desc(d2$weight_kg)

# BMI

d2$BMI[d2$BMI == -9]<- NA

proc_desc(d2$BMI)

# make BMI meaningful so if BMI > 45, then converted to 45

d2$BMI[d2$BMI > 45]<- 45

proc_desc(d2$BMI)

# antiplatelet agent before surgery
# either aspirin, clopidogrel or other G2P3 antagonist

d2$antiplt <- with(d2, ifelse((pre_med_ass == 1|pre_med_clopidogrel == 1| pre_med_Gp2b_3A_antagonist == 1), 1, 0))

proc_tab(d2$antiplt)

# diabetes

proc_tab(d2$diabetes)

d2$diabetes[d2$diabetes == -9]<- NA

proc_tab(d2$diabetes)

```


now to tackle col 21:30 of the data

```{r}
d3 <- d2

glimpse(d3)
```

make changes to the important variables

```{r}
# copd

proc_tab(d3$COPD) # no missing in COPD

proc_tab(d3$hyperlipemia) # convert to na

d3$hyperlipemia[d3$hyperlipemia == -9]<- NA

proc_tab(d3$hyperlipemia)

proc_tab(d3$peripheral_vascular_disease)

d3$pad <- input_na(d3$peripheral_vascular_disease, -9)

proc_tab(d3$pad) # pad


proc_desc(d3$pre_creatinine_mg_dl)

d3$creat_pre <- input_na(d3$pre_creatinine_mg_dl, -9)

proc_desc(d3$creat_pre) # significant # missing

proc_tab(d3$pre_dialysis)

d3$pre_dialysis <- input_na(d3$pre_dialysis, -9)

proc_tab(d3$pre_dialysis) # 14 missing 


# lvef function

proc_tab(d3$pre_LVEF_function)

d3$pre_LVEF_function <- input_na(d3$pre_LVEF_function, -9)

proc_tab(d3$pre_LVEF_function)

#- not going to use lvef as not that important

```

move forward with variables

```{r}

d4 <- d3

glimpse(d4)

```

```{r}

# pre_heartrhythm

proc_tab(d4$pre_heartrhythm)

d4$pre_heartrhythm <- input_na(d4$pre_heartrhythm, 9)

d4$pre_heartrhythm <- input_na(d4$pre_heartrhythm, -9)

proc_tab(d4$pre_heartrhythm)

d4$pre_af <- with(d4, ifelse(pre_heartrhythm == 2, 1, 0))

proc_tab(d4$pre_af)

# aicd/pacemaker 

proc_tab(d4$PM_wearer)

proc_tab(d4$ICD_wearer)

d4$icd_pm <- with(d4, ifelse((PM_wearer == 1|ICD_wearer == 1), 1, 0))

proc_tab(d4$icd_pm) # has either icd or pacemaker

# NYHA class 

proc_tab(d4$pre_NYHA) # lot of data missing here, cannot use

# same story with CCS 

proc_tab(d4$priority)

d4$preop_status <- factor(d4$priority, levels = c(1,2,3),
                          labels = c("elective", "urgent", "emergent"))

proc_tab(d4$preop_status)

```
move further down 

```{r}

d5 <- d4

glimpse(d5)
```


```{r}

# prior PCI

proc_tab(d5$prior_PCI)

d5$prior_PCI <- input_na(d5$prior_PCI, -9)

proc_tab(d5$prior_PCI)

#  prior MI

proc_tab(d5$pre_MI)

d5$pre_MI <- input_na(d5$pre_MI, -9)

proc_tab(d5$pre_MI)

# prior stroke

proc_tab(d5$pre_CVA)

# prior IABP

table(d5$pre_iabp) # no one had preop IABP

# prior cardiac surgery

proc_tab(d5$prior_cardiac_surgery)

```

```{r}

glimpse(d5)

```


- now this table d5 contains all the cleaned data for all the demographic variables.
- need to make sure that all patients are midcab and remove tecab

```{r}

table(d5$CABG)

proc_tab(d5$MIDCAB)

proc_tab(d5$TECAB)

# now to remove those patients that had tecab

tecab <- read_excel("C:/github_rcode/midcab/data/tecab.xlsx", sheet = 1)

glimpse(tecab)

tecab <- tecab$tecab

d5$tecab_add <- with(d5, ifelse(Pat_ID %in% tecab, 1, 0))

proc_tab(d5$tecab_add)

d5$tecab_actual <- with(d5, ifelse((TECAB ==1 |tecab_add == 1), 1, 0))

proc_tab(d5$tecab_actual)

```
Have got most recent data. that is *new table* in the folder

Redone all the prior code with the new table and all is good. Am using the most recent data and new table for all further analysis.

Have done the demographics part. Now to do the surgery part and then follow-up part and long-term survival. 

So, with removal of the duplicated patient, this new table will also contain the same patients as the earlier table. So, I will plan to use this new table instead and remove those patients that are not TECAB.

tecab_actual contains all tecab patients.
to remove that

----------------------------------------------------------------

```{r}

d6 <- d5 %>% filter(tecab_actual == 0) # no tecab

table(d6$tecab_actual)

# confirms that now the data does not contain any tecab patients
# write this data as demographics cleaned

write_csv(d6, 'C:/github_rcode/midcab/data/d_demo.csv')
```

d_demo is now master.

```{r}
# get the d_demo data into the script

d <- read_csv("c:/github_rcode/midcab/data/d_demo.csv")

dim(d)

glimpse(d)


#- am going to work with the op details now


```


```{r}

# these are the important op details that we need to look at
# coversion to CPB is provided in the other more recent table 
# cpb is the new excel sheet with contains patient id for all patients operated with CPB

opdetails <- c( "conversion_to_onpump", "onpump_beating_heart", 
"incompl_revascularisation",  
"initial_thoracotomy", "conversion_to_full_sternotomy", "length_of_surgery", 
"bypass_time", "cross_clamp_time", "cardiopleg_type", "cardiopleg_tech", 
"cardiopleg_ml", "min_temperature")

```

```{r}

#- working on d table to clean the operative details more

proc_tab(d$conversion_to_onpump)

#- am going to get the cpb table

cpb <- read_excel("C:/github_rcode/midcab/data/cpb.xlsx", sheet = 1)

cpb <- cpb$cpb

d$cpb <- with(d, if_else()

```

