---
title: "midcab_demographics"
author: "Salil V Deo"
date: "4/18/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report for initial data cleaning for the **midcab** paper.

```{r get libraries}

library(easypackages)
libraries(c("tidyverse","pastecs","skimr",
           "readxl","readr","survival","relsurv","lubridate","gmodels"))



proc_desc <- function(x){
  # require library(pastecs)
  result <- round(stat.desc(x),2)
  hist(x, col = "skyblue")
  result
}


proc_tab <- function(x){
  # require libary(gmodels)
  CrossTable(x, format = "SPSS")
  
}


# na converter


input_na <- function(x, y){
  ifelse(x == y, NA, x)
}
```



```{r}

# get data
# this the sheet 1 for the file 


df <- read_excel("C:\\github_rcode\\midcab\\data\\new_table.xlsx", sheet = 1)

dim(df)

glimpse(df)

# create data into sections according to the information
# Pat_ID is the patient indicator
# create table demo with baseline demographics first and then clean that


demo <- c("lfdNr", "THG_Referenz", "Aufnahme_Nr", "Pat_ID", "date_of_surgery", 
  "dob", "age_at_surgery", "gender", "admission", "height_cm", 
  "weight_kg", "BMI", "BSA_Mosteller", "pre_med_ass", "pre_med_clopidogrel", 
  "pre_med_Gp2b_3A_antagonist", "pre_med_nitrate_iv", "pre_med_inotropika", 
  "diabetes", "art_hypertension", "pulm_hypertension>60mmHg", "smoker", 
  "hyperlipemia", "COPD", "peripheral_vascular_disease", "pre_creatinine_mg_dl", 
  "pre_dialysis", "preGFR_CockcroftGault", "pre_LVEF", "pre_LVEF_function", 
  "pre_heartrhythm", "PM_wearer", "ICD_wearer", "pre_NYHA", "pre_CCS", 
  "pre_ASA", "priority", "elective", "urgent", "emergency", "critical_preoperative_state", 
  "pre_reanimation", "pre_ventilation", "coronary_disease_detail", 
  "left_main_disease", "pre_lyse", "prior_PCI", "last_PCI_date", 
  "pre_MI", "pre_MI<48hours", "pre_MI_2_to_<21days", "pre_MI_21_to_<91days", 
  "pre_MI_>90days", "pre_CVA", "pre_neurological_dysfunction", 
  "pre_cardiac_shock", "pre_cardiac_shock<48hours", "pre_iabp", 
  "pre_ecmo", "typ_a_dissection", "diss_iatrogen", "active_endocarditis", 
  "postinfarct_septal_rupture", "prior_cardiac_surgery", "last_cardiac_surgery_date", 
  "additive_euroSCORE", "logistic_euroscore", "CABG", "OPCAB", 
  "MIDCAB", "TECAB")

demog <- df[,c(demo)] # demog now has all the demographic information for all the patients

# check if the rows are unique

duplicates <- demog[duplicated(demog$Pat_ID),] # duplicated numbers 

# duplicate patient id

duplicates %>% select(Pat_ID) 
```

There is 1 duplicate patient. This is the demographics table; all that is the same. So I have kept 1 row and removed the other in table *demog2*.


```{r}
demog2 <- demog %>% 
  group_by(Pat_ID) %>%
  filter(!duplicated(Pat_ID)| n() == 1)

```

To confirm that all unique in table *demog2*

```{r}
duplicates <- demog2[duplicated(demog2$Pat_ID), ]

dim(duplicates)

```

Now to see the data and work on cleaning.
*demog2* now has 71 col. That is going to be the master df now.

```{r}

# get the first 10 col

d <- demog2

glimpse(d)

```

```{r}
# age 

proc_desc(d$age_at_surgery)

# age ok ; no missing 

# convert dates to date in R 

d$date_of_surgery <- as_date(d$date_of_surgery)

d$dob <- as_date(d$dob)

# gender

str(d$gender)

table(d$gender, useNA = 'ifany') # no missing gender 1 = male, 2= female

# conv to female

d$female <- d$gender - 1

d$female <- factor(d$female, levels = c(0,1), labels = c("no","yes"))

proc_tab(d$female)

# height_cm

proc_desc(d$height_cm) # missing = -9

# convert that to missing data

d$height_cm[d$height_cm == -9]<- NA

proc_desc(d$height_cm) 

```


now go for the next 10 variables 

```{r}
d2 <- d

glimpse(d2)
```


```{r}

# weight

d2$weight_kg[d2$weight_kg == -9]<- NA

proc_desc(d2$weight_kg)

# BMI

d2$BMI[d2$BMI == -9]<- NA

proc_desc(d2$BMI)

# make BMI meaningful so if BMI > 45, then converted to 45

d2$BMI[d2$BMI > 45]<- 45

proc_desc(d2$BMI)

# antiplatelet agent before surgery
# either aspirin, clopidogrel or other G2P3 antagonist

d2$antiplt <- with(d2, ifelse((pre_med_ass == 1|pre_med_clopidogrel == 1| pre_med_Gp2b_3A_antagonist == 1), 1, 0))

proc_tab(d2$antiplt)

# diabetes

proc_tab(d2$diabetes)

d2$diabetes[d2$diabetes == -9]<- NA

proc_tab(d2$diabetes)

```


now to tackle col 21:30 of the data

```{r}
d3 <- d2

glimpse(d3)
```

make changes to the important variables

```{r}
# copd

proc_tab(d3$COPD) # no missing in COPD

proc_tab(d3$hyperlipemia) # convert to na

d3$hyperlipemia[d3$hyperlipemia == -9]<- NA

proc_tab(d3$hyperlipemia)

proc_tab(d3$peripheral_vascular_disease)

d3$pad <- input_na(d3$peripheral_vascular_disease, -9)

proc_tab(d3$pad) # pad


proc_desc(d3$pre_creatinine_mg_dl)

d3$creat_pre <- input_na(d3$pre_creatinine_mg_dl, -9)

proc_desc(d3$creat_pre) # significant # missing

proc_tab(d3$pre_dialysis)

d3$pre_dialysis <- input_na(d3$pre_dialysis, -9)

proc_tab(d3$pre_dialysis) # 14 missing 


# lvef function

proc_tab(d3$pre_LVEF_function)

d3$pre_LVEF_function <- input_na(d3$pre_LVEF_function, -9)

proc_tab(d3$pre_LVEF_function)

#- not going to use lvef as not that important

```

move forward with variables

```{r}

d4 <- d3

glimpse(d4)

```

```{r}

# pre_heartrhythm

proc_tab(d4$pre_heartrhythm)

d4$pre_heartrhythm <- input_na(d4$pre_heartrhythm, 9)

d4$pre_heartrhythm <- input_na(d4$pre_heartrhythm, -9)

proc_tab(d4$pre_heartrhythm)

d4$pre_af <- with(d4, ifelse(pre_heartrhythm == 2, 1, 0))

proc_tab(d4$pre_af)

# aicd/pacemaker 

proc_tab(d4$PM_wearer)

proc_tab(d4$ICD_wearer)

d4$icd_pm <- with(d4, ifelse((PM_wearer == 1|ICD_wearer == 1), 1, 0))

proc_tab(d4$icd_pm) # has either icd or pacemaker

# NYHA class 

proc_tab(d4$pre_NYHA) # lot of data missing here, cannot use

# same story with CCS 

proc_tab(d4$priority)

d4$preop_status <- factor(d4$priority, levels = c(1,2,3),
                          labels = c("elective", "urgent", "emergent"))

proc_tab(d4$preop_status)

```
move further down 

```{r}

d5 <- d4

glimpse(d5)
```


```{r}

# prior PCI

proc_tab(d5$prior_PCI)

d5$prior_PCI <- input_na(d5$prior_PCI, -9)

proc_tab(d5$prior_PCI)

#  prior MI

proc_tab(d5$pre_MI)

d5$pre_MI <- input_na(d5$pre_MI, -9)

proc_tab(d5$pre_MI)

# prior stroke

proc_tab(d5$pre_CVA)

# prior IABP

table(d5$pre_iabp) # no one had preop IABP

# prior cardiac surgery

proc_tab(d5$prior_cardiac_surgery)

```

```{r}

glimpse(d5)

```


- now this table d5 contains all the cleaned data for all the demographic variables.
- need to make sure that all patients are midcab and remove tecab

```{r}

table(d5$CABG)

proc_tab(d5$MIDCAB)

proc_tab(d5$TECAB)

# now to remove those patients that had tecab

tecab <- read_excel("C:/github_rcode/midcab/data/tecab.xlsx", sheet = 1)

glimpse(tecab)

tecab <- tecab$tecab

d5$tecab_add <- with(d5, ifelse(Pat_ID %in% tecab, 1, 0))

proc_tab(d5$tecab_add)

d5$tecab_actual <- with(d5, ifelse((TECAB ==1 |tecab_add == 1), 1, 0))

proc_tab(d5$tecab_actual)

```
Have got most recent data. that is *new table* in the folder

Redone all the prior code with the new table and all is good. Am using the most recent data and new table for all further analysis.

Have done the demographics part. Now to do the surgery part and then follow-up part and long-term survival. 

So, with removal of the duplicated patient, this new table will also contain the same patients as the earlier table. So, I will plan to use this new table instead and remove those patients that are not TECAB.

Am going to rerun the prior code with the new table.

----------------------------------------------------------------



